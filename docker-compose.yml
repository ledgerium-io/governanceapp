version: '3'
services:
  eth-stats:
    image: 'quay.io/amis/ethstats:latest'
    ports:
      - '3000:3000'
    environment:
      - WS_SECRET=bb98a0b6442334d0cdf8a31b267892c1
    restart: always
    networks:
      test_net:
        ipv4_address: 172.19.240.9
  validator-0:
    hostname: validator-0
    image: 'ledgeriumengineering/quorum:fdlimit-bump'
    ports:
      - '30303:30303'
      - '8545:8545'
      - '9000:9000'
    volumes:
      - 'validator-0:/eth'
      - 'constellation-0:/constellation:z'
      - './tmp:/tmp'
      - './logs:/logs'
    depends_on:
      - constellation-0
    environment:
      - PRIVATE_CONFIG=/constellation/tm.conf
    entrypoint:
      - /bin/sh
      - '-c'
      - >+
        while [ ! -e /constellation/tm.ipc ];do

        sleep 1

        echo "waiting for priv impl..."

        done

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /eth/geth.ipc

        if [ ! -e /eth/genesis.json ];then

        mkdir -p /eth

        mkdir -p /logs/gethLogs

        cp /tmp/genesis.json /eth/genesis.json

        cp /tmp/static-nodes.json /eth/static-nodes.json

        cp /constellation/tm.pub /tmp/tm0.pub

        geth init /eth/genesis.json --datadir /eth

        echo 'pas123' > ./password

        echo '83a5803e698a3642d5309f119643f6a729c7c51fac00fdffac31983cb5275bb5'
        > ./file

        geth account import file --datadir /eth --password password

        rm -f ./file && rm -f ./password

        fi

        geth --rpc --rpcaddr '0.0.0.0' --rpccorsdomain '*' --datadir '/eth'
        --rpcapi 'db,eth,net,web3,istanbul,personal,admin,debug,txpool' --ws
        --wsorigins '*' --wsapi 'db,eth,net,web3,personal,admin,debug,txpool'
        --wsaddr '0.0.0.0' --networkid 2018 --targetgaslimit 9007199254740000
        --debug --metrics --syncmode 'full' --gasprice 0 --mine --verbosity 3
        --emitcheckpoints --istanbul.blockperiod 1 --mine --minerthreads 1
        --syncmode full --identity "validator-0" --nodekeyhex
        "83a5803e698a3642d5309f119643f6a729c7c51fac00fdffac31983cb5275bb5"
        --etherbase "f232a4bf183cf17d09bea23e19ceff58ad9dbfed" --port "30303"
        --ethstats
        "validator-0:bb98a0b6442334d0cdf8a31b267892c1@172.19.240.9:3000"
        --rpcport 8545 --wsport 9000
        2>/logs/gethLogs/$${DATE}_validator-0_Log.txt

    networks:
      test_net:
        ipv4_address: 172.19.240.10
    restart: always
  constellation-0:
    hostname: constellation-0
    image: 'quorumengineering/constellation:latest'
    ports:
      - '10000:10000'
    volumes:
      - 'constellation-0:/constellation:z'
      - './logs:/logs'
    entrypoint:
      - /bin/sh
      - '-c'
      - >
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /constellation/tm.ipc

        if [ ! -e "/constellation/tm.pub" ];then

        mkdir -p /constellation

        mkdir -p /logs/constellationLogs

        echo
        "socket=\"/constellation/tm.ipc\"\npublickeys=[\"/constellation/tm.pub\"]\n"
        > /constellation/tm.conf

        constellation-node --generatekeys=/constellation/tm

        cp /constellation/tm.pub /tmp/tm0.pub

        fi

        constellation-node --socket=/constellation/tm.ipc
        --publickeys=/constellation/tm.pub --privatekeys=/constellation/tm.key
        --storage=/constellation --verbosity=4
        --othernodes=http://172.19.240.101:10001/,http://172.19.240.102:10002/,http://172.19.240.103:10003/
        --url=http://172.19.240.100:10000/ --port=10000
        2>/logs/constellationLogs/$${DATE}_validator-0_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.100
    restart: always
  governance-ui-0:
    hostname: governance-ui-0
    image: 'ledgeriumengineering/governance_app_ui_img:new_metamask'
    ports:
      - '3545:3003'
    volumes:
      - 'validator-0:/eth'
      - 'constellation-0:/constellation:z'
    depends_on:
      - validator-0
    entrypoint:
      - /bin/sh
      - '-c'
      - >-
        mkdir -p /logs/governanceappLogs

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        cd /ledgerium/governanceapp/governanceApp

        node index.js protocol=http hostname=localhost port=8545
        privateKeys=83a5803e698a3642d5309f119643f6a729c7c51fac00fdffac31983cb5275bb5,9d698949e6ddb9086c34409b16f81c854ef2d7f73e020db7f896ed615efa25b1,02a121dc9a44f48c3630210f6643eeb148f6c418908788457f6b72892f9f3516

        cd /ledgerium/governanceapp/governanceApp/app

        node governanceUI.js 172.19.240.10 8545
         2>/logs/governanceappLogs/$${DATE}_validator-0_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.150
  validator-1:
    hostname: validator-1
    image: 'ledgeriumengineering/quorum:fdlimit-bump'
    ports:
      - '30304:30303'
      - '8546:8545'
      - '9001:9000'
    volumes:
      - 'validator-1:/eth'
      - 'constellation-1:/constellation:z'
      - './tmp:/tmp'
      - './logs:/logs'
    depends_on:
      - constellation-1
    environment:
      - PRIVATE_CONFIG=/constellation/tm.conf
    entrypoint:
      - /bin/sh
      - '-c'
      - >+
        while [ ! -e /constellation/tm.ipc ];do

        sleep 1

        echo "waiting for priv impl..."

        done

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /eth/geth.ipc

        if [ ! -e /eth/genesis.json ];then

        mkdir -p /eth

        mkdir -p /logs/gethLogs

        cp /tmp/genesis.json /eth/genesis.json

        cp /tmp/static-nodes.json /eth/static-nodes.json

        cp /constellation/tm.pub /tmp/tm1.pub

        geth init /eth/genesis.json --datadir /eth

        echo 'pas123' > ./password

        echo '9d698949e6ddb9086c34409b16f81c854ef2d7f73e020db7f896ed615efa25b1'
        > ./file

        geth account import file --datadir /eth --password password

        rm -f ./file && rm -f ./password

        fi

        geth --rpc --rpcaddr '0.0.0.0' --rpccorsdomain '*' --datadir '/eth'
        --rpcapi 'db,eth,net,web3,istanbul,personal,admin,debug,txpool' --ws
        --wsorigins '*' --wsapi 'db,eth,net,web3,personal,admin,debug,txpool'
        --wsaddr '0.0.0.0' --networkid 2018 --targetgaslimit 9007199254740000
        --debug --metrics --syncmode 'full' --gasprice 0 --mine --verbosity 3
        --emitcheckpoints --istanbul.blockperiod 1 --mine --minerthreads 1
        --syncmode full --identity "validator-1" --nodekeyhex
        "9d698949e6ddb9086c34409b16f81c854ef2d7f73e020db7f896ed615efa25b1"
        --etherbase "645cab2686477cd244562d4bd95a75f157a4c055" --port "30303"
        --ethstats
        "validator-1:bb98a0b6442334d0cdf8a31b267892c1@172.19.240.9:3000"
        --rpcport 8545 --wsport 9000
        2>/logs/gethLogs/$${DATE}_validator-1_Log.txt

    networks:
      test_net:
        ipv4_address: 172.19.240.11
    restart: always
  constellation-1:
    hostname: constellation-1
    image: 'quorumengineering/constellation:latest'
    ports:
      - '10001:10001'
    volumes:
      - 'constellation-1:/constellation:z'
      - './logs:/logs'
    entrypoint:
      - /bin/sh
      - '-c'
      - >
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /constellation/tm.ipc

        if [ ! -e "/constellation/tm.pub" ];then

        mkdir -p /constellation

        mkdir -p /logs/constellationLogs

        echo
        "socket=\"/constellation/tm.ipc\"\npublickeys=[\"/constellation/tm.pub\"]\n"
        > /constellation/tm.conf

        constellation-node --generatekeys=/constellation/tm

        cp /constellation/tm.pub /tmp/tm1.pub

        fi

        constellation-node --socket=/constellation/tm.ipc
        --publickeys=/constellation/tm.pub --privatekeys=/constellation/tm.key
        --storage=/constellation --verbosity=4
        --othernodes=http://172.19.240.100:10000/,http://172.19.240.102:10002/,http://172.19.240.103:10003/
        --url=http://172.19.240.101:10001/ --port=10001
        2>/logs/constellationLogs/$${DATE}_validator-1_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.101
    restart: always
  governance-ui-1:
    hostname: governance-ui-1
    image: 'ledgeriumengineering/governance_app_ui_img:new_metamask'
    ports:
      - '3546:3003'
    volumes:
      - 'validator-1:/eth'
      - 'constellation-1:/constellation:z'
    depends_on:
      - validator-1
    entrypoint:
      - /bin/sh
      - '-c'
      - |-
        mkdir -p /logs/governanceappLogs
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`
        cd /ledgerium/governanceapp/governanceApp/app
        node governanceUI.js 172.19.240.11 8545
         2>/logs/governanceappLogs/$${DATE}_validator-1_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.151
  validator-2:
    hostname: validator-2
    image: 'ledgeriumengineering/quorum:fdlimit-bump'
    ports:
      - '30305:30303'
      - '8547:8545'
      - '9002:9000'
    volumes:
      - 'validator-2:/eth'
      - 'constellation-2:/constellation:z'
      - './tmp:/tmp'
      - './logs:/logs'
    depends_on:
      - constellation-2
    environment:
      - PRIVATE_CONFIG=/constellation/tm.conf
    entrypoint:
      - /bin/sh
      - '-c'
      - >+
        while [ ! -e /constellation/tm.ipc ];do

        sleep 1

        echo "waiting for priv impl..."

        done

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /eth/geth.ipc

        if [ ! -e /eth/genesis.json ];then

        mkdir -p /eth

        mkdir -p /logs/gethLogs

        cp /tmp/genesis.json /eth/genesis.json

        cp /tmp/static-nodes.json /eth/static-nodes.json

        cp /constellation/tm.pub /tmp/tm2.pub

        geth init /eth/genesis.json --datadir /eth

        echo 'pas123' > ./password

        echo '02a121dc9a44f48c3630210f6643eeb148f6c418908788457f6b72892f9f3516'
        > ./file

        geth account import file --datadir /eth --password password

        rm -f ./file && rm -f ./password

        fi

        geth --rpc --rpcaddr '0.0.0.0' --rpccorsdomain '*' --datadir '/eth'
        --rpcapi 'db,eth,net,web3,istanbul,personal,admin,debug,txpool' --ws
        --wsorigins '*' --wsapi 'db,eth,net,web3,personal,admin,debug,txpool'
        --wsaddr '0.0.0.0' --networkid 2018 --targetgaslimit 9007199254740000
        --debug --metrics --syncmode 'full' --gasprice 0 --mine --verbosity 3
        --emitcheckpoints --istanbul.blockperiod 1 --mine --minerthreads 1
        --syncmode full --identity "validator-2" --nodekeyhex
        "02a121dc9a44f48c3630210f6643eeb148f6c418908788457f6b72892f9f3516"
        --etherbase "a79f57a6884a71a25fd17c21549796a53c067376" --port "30303"
        --ethstats
        "validator-2:bb98a0b6442334d0cdf8a31b267892c1@172.19.240.9:3000"
        --rpcport 8545 --wsport 9000
        2>/logs/gethLogs/$${DATE}_validator-2_Log.txt

    networks:
      test_net:
        ipv4_address: 172.19.240.12
    restart: always
  constellation-2:
    hostname: constellation-2
    image: 'quorumengineering/constellation:latest'
    ports:
      - '10002:10002'
    volumes:
      - 'constellation-2:/constellation:z'
      - './logs:/logs'
    entrypoint:
      - /bin/sh
      - '-c'
      - >
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /constellation/tm.ipc

        if [ ! -e "/constellation/tm.pub" ];then

        mkdir -p /constellation

        mkdir -p /logs/constellationLogs

        echo
        "socket=\"/constellation/tm.ipc\"\npublickeys=[\"/constellation/tm.pub\"]\n"
        > /constellation/tm.conf

        constellation-node --generatekeys=/constellation/tm

        cp /constellation/tm.pub /tmp/tm2.pub

        fi

        constellation-node --socket=/constellation/tm.ipc
        --publickeys=/constellation/tm.pub --privatekeys=/constellation/tm.key
        --storage=/constellation --verbosity=4
        --othernodes=http://172.19.240.100:10000/,http://172.19.240.101:10001/,http://172.19.240.103:10003/
        --url=http://172.19.240.102:10002/ --port=10002
        2>/logs/constellationLogs/$${DATE}_validator-2_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.102
    restart: always
  governance-ui-2:
    hostname: governance-ui-2
    image: 'ledgeriumengineering/governance_app_ui_img:new_metamask'
    ports:
      - '3547:3003'
    volumes:
      - 'validator-2:/eth'
      - 'constellation-2:/constellation:z'
    depends_on:
      - validator-2
    entrypoint:
      - /bin/sh
      - '-c'
      - |-
        mkdir -p /logs/governanceappLogs
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`
        cd /ledgerium/governanceapp/governanceApp/app
        node governanceUI.js 172.19.240.12 8545
         2>/logs/governanceappLogs/$${DATE}_validator-2_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.152
  validator-3:
    hostname: validator-3
    image: 'ledgeriumengineering/quorum:fdlimit-bump'
    ports:
      - '30306:30303'
      - '8548:8545'
      - '9003:9000'
    volumes:
      - 'validator-3:/eth'
      - 'constellation-3:/constellation:z'
      - './tmp:/tmp'
      - './logs:/logs'
    depends_on:
      - constellation-3
    environment:
      - PRIVATE_CONFIG=/constellation/tm.conf
    entrypoint:
      - /bin/sh
      - '-c'
      - >+
        while [ ! -e /constellation/tm.ipc ];do

        sleep 1

        echo "waiting for priv impl..."

        done

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /eth/geth.ipc

        if [ ! -e /eth/genesis.json ];then

        mkdir -p /eth

        mkdir -p /logs/gethLogs

        cp /tmp/genesis.json /eth/genesis.json

        cp /tmp/static-nodes.json /eth/static-nodes.json

        cp /constellation/tm.pub /tmp/tm3.pub

        geth init /eth/genesis.json --datadir /eth

        echo 'pas123' > ./password

        echo 'bf96d1aabb87c249ef8c85f98476b11e114e0bc6e62a11582d376ece941ecf09'
        > ./file

        geth account import file --datadir /eth --password password

        rm -f ./file && rm -f ./password

        fi

        geth --rpc --rpcaddr '0.0.0.0' --rpccorsdomain '*' --datadir '/eth'
        --rpcapi 'db,eth,net,web3,istanbul,personal,admin,debug,txpool' --ws
        --wsorigins '*' --wsapi 'db,eth,net,web3,personal,admin,debug,txpool'
        --wsaddr '0.0.0.0' --networkid 2018 --targetgaslimit 9007199254740000
        --debug --metrics --syncmode 'full' --gasprice 0 --mine --verbosity 3
        --emitcheckpoints --istanbul.blockperiod 1 --mine --minerthreads 1
        --syncmode full --identity "validator-3" --nodekeyhex
        "bf96d1aabb87c249ef8c85f98476b11e114e0bc6e62a11582d376ece941ecf09"
        --etherbase "f7dce95345c5a5917360571165260cf0e8d98918" --port "30303"
        --ethstats
        "validator-3:bb98a0b6442334d0cdf8a31b267892c1@172.19.240.9:3000"
        --rpcport 8545 --wsport 9000
        2>/logs/gethLogs/$${DATE}_validator-3_Log.txt

    networks:
      test_net:
        ipv4_address: 172.19.240.13
    restart: always
  constellation-3:
    hostname: constellation-3
    image: 'quorumengineering/constellation:latest'
    ports:
      - '10003:10003'
    volumes:
      - 'constellation-3:/constellation:z'
      - './logs:/logs'
    entrypoint:
      - /bin/sh
      - '-c'
      - >
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        rm -f /constellation/tm.ipc

        if [ ! -e "/constellation/tm.pub" ];then

        mkdir -p /constellation

        mkdir -p /logs/constellationLogs

        echo
        "socket=\"/constellation/tm.ipc\"\npublickeys=[\"/constellation/tm.pub\"]\n"
        > /constellation/tm.conf

        constellation-node --generatekeys=/constellation/tm

        cp /constellation/tm.pub /tmp/tm3.pub

        fi

        constellation-node --socket=/constellation/tm.ipc
        --publickeys=/constellation/tm.pub --privatekeys=/constellation/tm.key
        --storage=/constellation --verbosity=4
        --othernodes=http://172.19.240.100:10000/,http://172.19.240.101:10001/,http://172.19.240.102:10002/
        --url=http://172.19.240.103:10003/ --port=10003
        2>/logs/constellationLogs/$${DATE}_validator-3_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.103
    restart: always
  governance-ui-3:
    hostname: governance-ui-3
    image: 'ledgeriumengineering/governance_app_ui_img:new_metamask'
    ports:
      - '3548:3003'
    volumes:
      - 'validator-3:/eth'
      - 'constellation-3:/constellation:z'
    depends_on:
      - validator-3
    entrypoint:
      - /bin/sh
      - '-c'
      - |-
        mkdir -p /logs/governanceappLogs
        DATE=`date '+%Y-%m-%d_%H-%M-%S'`
        cd /ledgerium/governanceapp/governanceApp/app
        node governanceUI.js 172.19.240.13 8545
         2>/logs/governanceappLogs/$${DATE}_validator-3_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.153
  quorum-maker:
    hostname: quorum-maker
    image: 'ledgeriumengineering/quorum-maker:v0.1'
    ports:
      - '9999:9999'
    volumes:
      - './logs:/logs'
      - './tmp:/tmp'
      - 'quorum-maker:/quorum-maker'
      - 'validator-0:/eth'
      - 'constellation-0:/constellation:z'
    depends_on:
      - validator-0
    entrypoint:
      - /bin/sh
      - '-c'
      - >
        set -u

        set -e

        mkdir -p /logs/quorummakerLogs

        DATE=`date '+%Y-%m-%d_%H-%M-%S'`

        while : ;do

        sleep 1

        if [ -e /eth/geth.ipc ];then

        break;

        fi

        done

        cd /quorum-maker

        if [ ! -e /quorum-maker/setup.conf ];then

        RESPONSE=`curl https://ipinfo.io/ip` || "--"

        echo "EXTERNAL_IP=$${RESPONSE}" > ./setup.conf

        echo "CONTRACT_ADD=" >> setup.conf

        echo "RPC_PORT=8545" >> ./setup.conf

        echo "WS_PORT=9000" >> ./setup.conf

        echo "WHISPER_PORT=30303" >> ./setup.conf

        echo "CONSTELLATION_PORT=10000" >> ./setup.conf

        echo "TOTAL_NODES=4" >> ./setup.conf

        echo "RAFT_ID=0" >> ./setup.conf

        echo "MODE=ACTIVE" >> ./setup.conf

        echo "STATE=I" >> ./setup.conf

        echo
        "PRIVATE_KEY=83a5803e698a3642d5309f119643f6a729c7c51fac00fdffac31983cb5275bb5"
        >> ./setup.conf

        if [ -e /tmp/tm0.pub ];then

        PUB=$$(cat /tmp/tm0.pub)

        fi

        echo "PUBKEY="$${PUB} >> ./setup.conf

        echo "ROLE=Unassigned" >> ./setup.conf

        echo "CURRENT_IP=172.19.240.10" >> ./setup.conf

        echo "REGISTERED=" >> ./setup.conf

        echo "NODENAME=validator-"0 >> ./setup.conf

        echo "1_RAFT_ID=1"  >> ./setup.conf

        echo
        "1_ENODE=bfddbfe19b42ba51f3f35d9300e629517018a0e82fa1728c9f1dce04d539bb8e7db31b83d60ee5b31558c7bbdd34b420446a61b8d4235815726d568d26b8ae48"
        >> ./setup.conf

        if [ -e /tmp/tm1.pub ];then

        PUB=$$(cat /tmp/tm1.pub)

        fi

        echo "1_PUBKEY="$${PUB} >> ./setup.conf

        echo "1_ROLE=Unassigned" >> ./setup.conf

        echo "1_CURRENT_IP=172.19.240.11" >> ./setup.conf

        echo "1_REGISTERED=" >> ./setup.conf

        echo "1_NODENAME=validator-"1 >> ./setup.conf

        echo "2_RAFT_ID=2"  >> ./setup.conf

        echo
        "2_ENODE=9530e557787fd29c2e6ca995b29201248fdc06ba1b81a3ec649df88f7175536c42641fa7015db9c4e5bae679e4276fe00d54fcb71770ff7376fd1d12e37533b5"
        >> ./setup.conf

        if [ -e /tmp/tm2.pub ];then

        PUB=$$(cat /tmp/tm2.pub)

        fi

        echo "2_PUBKEY="$${PUB} >> ./setup.conf

        echo "2_ROLE=Unassigned" >> ./setup.conf

        echo "2_CURRENT_IP=172.19.240.12" >> ./setup.conf

        echo "2_REGISTERED=" >> ./setup.conf

        echo "2_NODENAME=validator-"2 >> ./setup.conf

        echo "3_RAFT_ID=3"  >> ./setup.conf

        echo
        "3_ENODE=b03fbba5b7e0a52d34a6051dcd89ff1ff1f1cae802e053528905d91d6c2ee3c2c734e5467c62146db98112ef35bb9171e6e5acfba620f88723d62079f7c90182"
        >> ./setup.conf

        if [ -e /tmp/tm3.pub ];then

        PUB=$$(cat /tmp/tm3.pub)

        fi

        echo "3_PUBKEY="$${PUB} >> ./setup.conf

        echo "3_ROLE=Unassigned" >> ./setup.conf

        echo "3_CURRENT_IP=172.19.240.13" >> ./setup.conf

        echo "3_REGISTERED=" >> ./setup.conf

        echo "3_NODENAME=validator-"3 >> ./setup.conf

        fi

        cd /root/quorum-maker/

        ./NodeManager http://172.19.240.10:8545 9999 /logs/gethLogs/
        /logs/constellationLogs /quorum-maker/setup.conf
        2>/logs/quorummakerLogs/$${DATE}_Log.txt
    networks:
      test_net:
        ipv4_address: 172.19.240.196
    restart: always
volumes:
  quorum-maker: 
  constellation-0: 
  validator-0: 
  constellation-1: 
  validator-1: 
  constellation-2: 
  validator-2: 
  constellation-3: 
  validator-3: 
networks:
  test_net:
    external: true
